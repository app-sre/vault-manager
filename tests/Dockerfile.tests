# build vault-manager binary
FROM registry.access.redhat.com/ubi9/go-toolset:1.21 AS builder
COPY --chown=1001:0 . .
# Taken from the top-level Makefile
RUN make gobuild

# Test image
# Setup prerequisites for testing
FROM registry.access.redhat.com/ubi9/ubi:9.4

ENV BATS_VERSION="v1.11.1"
ENV VAULT_VERSION="1.17.1"

RUN yum install -y \
    ca-certificates \
    git \
    jq \
    podman \
    unzip \
    wget && \
    yum clean all && \
    update-ca-trust extract

RUN git clone https://github.com/bats-core/bats-core.git && \
    git --git-dir=bats-core/.git checkout -b $BATS_VERSION $BATS_VERSION >/dev/null && \
    bats-core/install.sh /usr/local

RUN wget https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip && \
    unzip vault_${VAULT_VERSION}_linux_amd64.zip && \
    mv vault /usr/bin

# copy vault-manager binary from builder
COPY tests/ /tests/
COPY --from=builder /opt/app-root/src/vault-manager /bin/

WORKDIR /tests

CMD ["bash", "run-tests.sh"]
