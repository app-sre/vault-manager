---
apiVersion: v1
kind: Pod
metadata:
  name: vault-manager-test
  labels:
    app: vault-manager-test
spec:
  restartPolicy: Never
  containers:
  - name: test
    # IMAGE_PLACEHOLDER will be replaced by the script
    image: IMAGE_PLACEHOLDER
    env:
    - name: PRIMARY_VAULT_URL
      value: http://primary-vault:8200
    - name: SECONDARY_VAULT_URL
      value: http://secondary-vault:8202
    - name: KEYCLOAK_URL
      value: http://keycloak:8180
    - name: GRAPHQL_SERVER
      value: http://qontract-server:4000/graphql
    - name: VAULT_ADDR
      value: http://primary-vault:8200
    - name: VAULT_TOKEN
      value: root
    - name: VAULT_AUTHTYPE
      value: token
    - name: LOG_FILE_LOCATION
      value: /tmp/vault-manager.log
    - name: PODMAN_IGNORE_CGROUPSV1_WARNING
      value: "1"
    command: ["/bin/bash", "-c"]
    args:
    - |
      set -e

      echo "Waiting for services to be ready..."
      for url in "${KEYCLOAK_URL}/realms/master" \
                 "http://qontract-server:4000/healthz" \
                 "${PRIMARY_VAULT_URL}/v1/sys/health" \
                 "${SECONDARY_VAULT_URL}/v1/sys/health"; do
        until curl -s -f -o /dev/null "$url"; do
          echo "Waiting for $url..."
          sleep 5
        done
      done

      echo "All services ready. Running BATS tests..."
      cd /tests

      # Run test suite with verbose output
      for test in $(find /tests/bats/ -type f | grep '\.bats' | grep -vE 'roles|entities|groups|errors'); do
        echo "Running $test"
        bats --tap --print-output-on-failure "$test"
      done

      echo "Running roles tests"
      bats --tap --print-output-on-failure /tests/bats/roles/roles.bats

      echo "Running entities tests"
      bats --tap --print-output-on-failure /tests/bats/entities/entities.bats

      echo "Running groups tests"
      bats --tap --print-output-on-failure /tests/bats/groups/groups.bats

      echo "Running error handling tests"
      bats --tap --print-output-on-failure /tests/bats/errors/errors.bats

      echo "All tests completed successfully!"
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"
