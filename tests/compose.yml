name: vault-manager-test

services:

  keycloak:
    image: quay.io/keycloak/keycloak
    ports:
      - "8180:8180"
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
    command: start-dev --http-port 8180 --http-relative-path /auth
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8180/auth"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s

  keycloak-cli:
    image: quay.io/app-sre/keycloak-config-cli:5.0.0-17.0.1
    environment:
      - KEYCLOAK_URL=http://keycloak:8180/auth
      - KEYCLOAK_USER=${KEYCLOAK_USER}
      - KEYCLOAK_PASSWORD=${KEYCLOAK_PASSWORD}
      - KEYCLOAK_AVAILABILITYCHECK_ENABLED=true
      - IMPORT_FILES=/config/*
    volumes:
      - ../tests/keycloak:/config:Z
    depends_on:
      - keycloak

  qontract-server:
    image: quay.io/app-sre/qontract-server:669e975
    environment:
      LOAD_METHOD: fs
      DATAFILES_FILE: /bundle/data.json
    volumes:
      - ../tests/app-interface:/bundle:Z

  primary-vault:
    image: quay.io/app-sre/vault:1.17.1
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
    cap_add:
      - IPC_LOCK
    depends_on:
      - qontract-server

  secondary-vault:
    image: quay.io/app-sre/vault:1.17.1
    ports:
      - "8202:8202"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8202
    cap_add:
      - IPC_LOCK
    depends_on:
      - qontract-server
      - primary-vault

  vault-manager-test:
    image: quay.io/app-sre/vault-manager-test:latest
    environment:
      HOST_PATH: ${PWD}
    volumes:
      - ../.env:/tests/.env:Z
    depends_on:
      - primary-vault
      - qontract-server
