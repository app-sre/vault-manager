# runs 5 containers:
# 1 keycloak
# 2 keycloak-cli
# 3 qontract-server
# 4 primary vault instance
# 5 secondary vault instance

name: vault-manager-test

services:

  keycloak:
    image: quay.io/keycloak/keycloak
    ports:
      - "8180:8280"
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
    network_mode: host

  keycloak-cli:
    image: quay.io/app-sre/keycloak-config-cli:5.0.0-17.0.1
    environment:
      - KEYCLOAK_URL: "http://localhost:8180/auth"
      - KEYCLOAK_USER: $KEYCLOAK_USER
      - KEYCLOAK_PASSWORD: $KEYCLOAK_PASSWORD
      - KEYCLOAK_AVAILABILITYCHECK_ENABLED: true
      - IMPORT_FILES: '/config/*'
    network_mode: host
    depends_on:
      - keycloak

  qontract-server:
    image: quay.io/app-sre/qontract-server:dc34527
    environment:
      LOAD_METHOD: fs
      DATAFILES_FILE: /bundle/data.json
    volumes:
      - tests/app-interface:/bundle
    network_mode: host

  primary-vault:
    image: quay.io/app-sre/vault:1.7.2
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
    network_mode: host
    cap_add:
      - IPC_LOCK

  secondary-vault:
    image: quay.io/app-sre/vault:1.7.2
    ports:
      - "8202:8202"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8202
    network_mode: host
    cap_add:
      - IPC_LOCK
